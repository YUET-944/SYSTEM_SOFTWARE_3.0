<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Business System API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav-button { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin: 5px; display: inline-block; }
        .nav-button:hover { background: #0056b3; }
        .back-button { background: #6c757d; }
        .back-button:hover { background: #545b62; }
        .response { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .current { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .auth-form { background: #fff; padding: 20px; border-radius: 4px; border: 1px solid #ddd; margin: 10px 0; max-width: 400px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .error { color: #dc3545; margin-top: 5px; }
        .success { color: #28a745; margin-top: 5px; }
        .user-info { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .logout-btn { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; float: right; }
        .logout-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>Universal Business System API</h1>
    
    <div id="userInfo" class="user-info" style="display: none;">
        <span id="userDetails"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div id="authSection">
        <div class="auth-form">
            <h3>Register</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label>Store Name (optional):</label>
                    <input type="text" id="regStoreName" placeholder="Leave blank for default store">
                </div>
                <button type="submit" class="btn">Register</button>
                <div id="registerError" class="error"></div>
                <div id="registerSuccess" class="success"></div>
            </form>
        </div>
        
        <div class="auth-form">
            <h3>Login</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username or Email:</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="loginError" class="error"></div>
                <div id="loginSuccess" class="success"></div>
            </form>
        </div>
    </div>

    <div id="content">
        <p>Please login or register to access the system.</p>
    </div>

    <script>
        let currentPath = window.location.pathname;
        let currentUser = null;
        
        // Check for existing token on page load
        checkExistingAuth();
        
        function checkExistingAuth() {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            
            if (token && userInfo) {
                currentUser = JSON.parse(userInfo);
                showUserInfo();
                loadEndpoint('/');
            }
        }
        
        // Register form handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const storeName = document.getElementById('regStoreName').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        storeName: storeName || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store token and user info
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userInfo', JSON.stringify(data));
                    
                    currentUser = data;
                    showUserInfo();
                    loadEndpoint('/');
                    
                    document.getElementById('registerSuccess').textContent = 'Registration successful! You are now logged in.';
                    document.getElementById('registerError').textContent = '';
                    document.getElementById('registerForm').reset();
                } else {
                    document.getElementById('registerError').textContent = data.message || 'Registration failed';
                    document.getElementById('registerSuccess').textContent = '';
                }
            } catch (error) {
                document.getElementById('registerError').textContent = 'Network error: ' + error.message;
                document.getElementById('registerSuccess').textContent = '';
            }
        });
        
        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store token and user info
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userInfo', JSON.stringify(data));
                    
                    currentUser = data;
                    showUserInfo();
                    loadEndpoint('/');
                    
                    document.getElementById('loginSuccess').textContent = 'Login successful!';
                    document.getElementById('loginError').textContent = '';
                    document.getElementById('loginForm').reset();
                } else {
                    document.getElementById('loginError').textContent = data.message || 'Login failed';
                    document.getElementById('loginSuccess').textContent = '';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Network error: ' + error.message;
                document.getElementById('loginSuccess').textContent = '';
            }
        });
        
        function showUserInfo() {
            if (currentUser) {
                document.getElementById('userDetails').textContent = 
                    `Logged in as: ${currentUser.username} | Store: ${currentUser.storeName || 'Default Store'}`;
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('authSection').style.display = 'none';
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('content').innerHTML = '<p>Please login or register to access the system.</p>';
        }
        
        async function loadEndpoint(path) {
            try {
                const token = localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token && path !== '/' && !path.startsWith('/api/auth')) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(path, { headers });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                displayResponse(data);
                currentPath = path;
                updateURL(path);
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="response">Error: ${error.message}</div>`;
            }
        }

        function displayResponse(data) {
            let html = '<div class="response">';
            
            if (data.message) {
                html += `<h2>${data.message}</h2>`;
            }
            
            if (data.data) {
                html += '<h3>Data:</h3><pre>' + JSON.stringify(data.data, null, 2) + '</pre>';
            }
            
            if (data.navigation) {
                html += '<div class="nav-section">';
                
                if (data.navigation.back) {
                    html += `<a href="#" onclick="loadEndpoint('${data.navigation.back.url}')" class="nav-button back-button">${data.navigation.back.text}</a><br><br>`;
                }
                
                if (data.navigation.current) {
                    html += `<div class="current">Current: ${data.navigation.current}</div>`;
                }
                
                if (data.navigation.endpoints) {
                    html += '<h3>Available Endpoints:</h3>';
                    data.navigation.endpoints.forEach(endpoint => {
                        html += `<a href="#" onclick="loadEndpoint('${endpoint.url}')" class="nav-button">${endpoint.text} (${endpoint.method})</a> `;
                    });
                }
                
                if (data.navigation.actions) {
                    html += '<h3>Actions:</h3>';
                    data.navigation.actions.forEach(action => {
                        html += `<a href="#" onclick="loadEndpoint('${action.url}')" class="nav-button">${action.text} (${action.method})</a> `;
                    });
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        function updateURL(path) {
            if (path !== window.location.pathname) {
                history.pushState({path: path}, '', path);
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.path) {
                loadEndpoint(event.state.path);
            }
        });

        // Load initial page
        if (currentPath === '/' || currentPath === '') {
            loadEndpoint('/');
        } else {
            loadEndpoint(currentPath);
        }
    </script>
</body>
</html>
